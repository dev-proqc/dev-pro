<!DOCTYPE html>
<html lang="fr-CA" class="no-js"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script><link media="all" href="https://dev-pro.xyz/blog/wp-content/cache/autoptimize/css/autoptimize_3856cada20bef986579d474c88d62b88.css" rel="stylesheet"><title>My first Linux kernel built with Clang compiler! â€“ Dev-Pro Informatique</title><script type="text/javascript" src="https://dev-pro.xyz/blog/wp-includes/js/jquery/jquery.js"></script><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
                     google_ad_client: "ca-pub-1370898179955590",
                     enable_page_level_ads: true
                });</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154856998-1"></script><script>window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-154856998-1');</script></head><body class="post-template-default single single-post postid-232 single-format-standard wp-custom-logo"><div class="body-wrap fullwidth-container"><nav class="navbar navbar-light bg-white border-bottom navbar-expand-lg justify-content-between px-5 py-4 fullwidth-container"><div class="navbar-brand py-0 mb-0"> <a href="https://dev-pro.xyz/blog/" class="custom-logo-link" rel="home"><noscript><img width="132" height="29" src="https://dev-pro.xyz/blog/wp-content/uploads/2019/12/logo.png" class="custom-logo" alt="Dev-Pro Informatique"></noscript><img width="132" height="29" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20132%2029%22%3E%3C/svg%3E" data-src="https://dev-pro.xyz/blog/wp-content/uploads/2019/12/logo.png" class="lazyload custom-logo" alt="Dev-Pro Informatique"></a> <a href="https://dev-pro.xyz/blog/" title="Dev-Pro Informatique" rel="home" class="site-title text-dark">Dev-Pro Informatique</a></div> <span class="navbar-text site-description text-info small d-none d-md-block">Solution Technologique</span> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle Navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbar-content"><ul id="primary-menu" class="navbar-nav ml-auto"><li id="menu-item-62" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-62 nav-item"><a href="https://dev-pro.xyz/blog/acceuil/" class="nav-link">Accueil</a></li></ul></div></nav><div class="container my-lg-5 my-sm-3"><div class="row"><div class="col-md-12 col-lg-8"><div class="content my-5"><article id="post-232" class="mb-5 post-232 post type-post status-publish format-standard hentry category-clang category-howto category-kernel category-linux"><p class="text-uppercase mb-1"><a href="https://dev-pro.xyz/blog/category/clang/" rel="category tag">clang</a>, <a href="https://dev-pro.xyz/blog/category/howto/" rel="category tag">HowTo</a>, <a href="https://dev-pro.xyz/blog/category/kernel/" rel="category tag">kernel</a>, <a href="https://dev-pro.xyz/blog/category/linux/" rel="category tag">Linux</a></p><h2 class="entry-title"><a href="https://dev-pro.xyz/blog/my-first-linux-kernel-built-with-clang-compiler/" rel="bookmark">My first Linux kernel built with Clang compiler!</a></h2><p class="meta text-muted text-info small"> By <a href="https://dev-pro.xyz/blog/author/siz/">siz</a> on dÃ©cembre 27, 2019 <span>â€¢</span> 0 Comments</p><div class="clearfix"></div><div class="entry"><div><p>Following his internship at Smile in 2018 on LLVM/Clang integration into Buildroot [1], Valentin Korenblit still maintains these packages on his spare time (thanks to him!), up to the latest current version llvm/Clang 8.0.0.</p><p>At the same time the Linux kernel continues evolving to support Clang compiler thanks to Google engineers. See Phoronix article [2] and Â«Â Compiling the Linux kernel with LLVM toolsÂ Â» conference at FOSDEM 2019 [3].</p><p>Valentin stated in his internship report:</p><blockquote class="wp-block-quote"><p>Clang was designed to offer GCC compatibility, so it accepts most of GCCâ€™s command line arguments to specify the compiler options. However, GCC offers a lot of extensions to the standard language while Clangâ€™s purpose is being standard-compliant. Because of this, Clang cannot be a replacement for GCC when compiling projects that depend on GCC extensions, as it happens with Linux kernel. In this case, Linux canâ€™t be built because Clang does not accept the following kinds of constructs:</p><p>â€¢ Variable length arrays inside structures<br>â€¢ Nested Functions<br>â€¢ Explicit register variables</p><p>Furthermore, Linux kernel still depends on GNU assembler and linker.</p><p><cite>http://www.linuxembedded.fr/2018/07/llvmclang-integration-into-buildroot/</cite></p></blockquote><p>In order to check by ourselves if it is now possible to compile a kernel with Clang using buildroot, we will compile the aarch64 configuration for Qemu (qemu_aarch64_virt_defconfig).<br>First, we will try with the GCC toolchain in order to verify that everything works fine. Then we will recompile the kernel with Clang.</p><pre class="wp-block-preformatted">$ make qemu_aarch64_virt_defconfig</pre><p>In order to speedup the build, we use an prebuilt external toolchain (Arm AArch64 2019.03) instead of an internal toolchain. We could also use an aarch64 toolchain downloaded from toolchain-builder project (<a href="https://toolchains.bootlin.com/">https://toolchains.bootlin.com</a>) that provide several toolchains generated by Buildroot.</p><p>When the build is finished, we can test the system using Qemu as indicated in the file Â«Â board/qemu/aarch64-virt/readme.txtÂ Â»</p><p>The system should boot correctly.<br>(If not, check your Qemu version and make sure itâ€™s at least at the same version as the one present in the readme.txt).</p><p>Now that we tested that the kernel build correctly with GCC, we are going to try again with Clang. To do that, we first clean the kernelâ€™s build directory</p><pre class="wp-block-preformatted">$ make linux-dirclean</pre><p>Note: We keep the user space content previously built by the GCC toolchain.<br>Building user space programs using Clang is not supported yet by buildroot.</p><p>We then need to build the Clang compiler itself. This is done by the host-clang package</p><p>We cannot select host-clang in buildrootâ€™s menuconfig, because host-clang can only be selected as a dependency of another package. We will simply trigger the host-clang build manually</p><pre class="wp-block-preformatted">$ make host-clang</pre><p>In order to cross-compile the kernel, we have to modify the Linuxâ€™s package Makefile (linux/linux.mk) as suggested in the following patch.</p><div class="wp-block-file"><a href="http://www.linuxembedded.fr/wp-content/uploads/2019/08/0001-linux-compile-with-clang.patch_.zip">0001-linux-compile-with-clang.patch</a></div><p>Now itâ€™s time to rebuild the kernel using Clang </p><noscript><img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley img-fluid" style="height: 1em; max-height: 1em;"></noscript><img src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="ðŸ™‚" class="lazyload wp-smiley img-fluid" style="height: 1em; max-height: 1em;"><br>Note: By default the qemu_aarch64_virt_defconfig uses a kernel 4.19.x, itâ€™s recommended to use the latest kernel version (5.2.7).<pre class="wp-block-preformatted">$ make linux</pre><p>The kernel build takes some time to complete, you can check the list of processes running on you build machine thanks to the htop command. You should notice some activity with clang-8 process.</p><p>When the build is finished (and successful), restart Qemu using the same command line as before.</p><p>The system should boot successfully and you can check the dmesg output to know the compiler used to build the kernel.</p><figure class="wp-block-image"><noscript><img class="wp-image-6720 img-fluid" src="http://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50.png" alt="" srcset="https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50.png 970w,https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50-300x110.png 300w,https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50-768x283.png 768w" sizes="(max-width: 970px) 100vw, 970px"></noscript><img class="lazyload wp-image-6720 img-fluid" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="http://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50.png" alt="" data-srcset="https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50.png 970w, https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50-300x110.png 300w, https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50-768x283.png 768w" data-sizes="(max-width: 970px) 100vw, 970px"></figure><h2>Conclusion:</h2><p>This is our first test with a Linux kernel with Clang cross-compiler, for now itâ€™s just a hack in Buildrootâ€™s linux package.<br>Buildroot is not able to use Clang as a generic compiler for all user-space yet. Adding this feature requires discussion with the Buildroot community.</p><p>This support would also require to change some hard-coded references within the Buildrootâ€™s package infrastructure. CMake and meson cross-compilation support, in particular, would need some work.</p><p>Buildroot probably needs a new toolchain-wrapper for Clang compiler to provide â€“sysroot path and other compiler options like it does for the GCC cross-toolchain.<br>Since the Clang compiler take a lot of time to build, it would be interesting to be able to reuse a prebuilt Clang compiler and import it in the toolchain-external package infrastructure. This would require that LLVM/Clang binaries be relocatable.<br>For now, only aarch64 kernel has been tested since it probably the most tested one with Clang [5]. It would be interesting to do further tests with other architectures like arm, x86, x86_64, mips, mips64, ppc, ppc64â€¦</p><p>References:</p><p>[1] <a href="http://www.linuxembedded.fr/2018/07/llvmclang-integration-into-buildroot">http://www.linuxembedded.fr/2018/07/llvmclang-integration-into-buildroot</a><br>[2] <a href="https://www.phoronix.com/scan.php?page=news_item&px=Google-2019-Clang-Kernel">https://www.phoronix.com/scan.php?page=news_item&px=Google-2019-Clang-Kernel</a><br>[3] <a href="https://fosdem.org/2019/schedule/event/llvm_kernel/attachments/slides/3330/export/events/attachments/llvm_kernel/slides/3330/clang_linux_fosdem_19.pdf">https://fosdem.org/2019/schedule/event/llvm_kernel/attachments/slides/3330/export/events/attachments/llvm_kernel/slides/3330/clang_linux_fosdem_19.pdf</a><br>[4] <a href="https://www.elinux.org/Buildroot:DeveloperDaysFOSDEM2018#LLVM.2FClang">https://www.elinux.org/Buildroot:DeveloperDaysFOSDEM2018#LLVM.2FClang</a><br>[5] <a href="https://www.phoronix.com/scan.php?page=news_item&px=Clang-Kernel-2018">https://www.phoronix.com/scan.php?page=news_item&px=Clang-Kernel-2018</a></p></div></div><div class="clearfix"></div></article><nav class="navigation post-navigation" role="navigation" aria-label="Articles"><h2 class="screen-reader-text">Navigation de l'article</h2><div class="nav-links"><div class="nav-previous"><a href="https://dev-pro.xyz/blog/europe-samsung-nest-plus-celui-qui-depense-le-plus-en-rd/" rel="prev"><i class="fa fa-angle-double-left" aria-hidden="true"></i><div>Europe : Samsung nâ€™est plus celui qui dÃ©pense le plus en R&D</div></a></div><div class="nav-next"><a href="https://dev-pro.xyz/blog/le-temps-reel-sous-linux/" rel="next">Le Temps Reel sous Linux <i class="fa fa-angle-double-right" aria-hidden="true"></i></a></div></div></nav></div></div><div class="col-md-12 col-lg-3 ml-auto"><div class="sidebar my-5"><aside id="recent-posts-2" class="widget widget_recent_entries mb-5"><h3 class="widget-title mt-0">Articles rÃ©cents</h3><ul><li> <a href="https://dev-pro.xyz/blog/storing-crash-data-of-the-linux-kernel-for-post-crash-debugging/">Storing crash data of the Linux kernel for post-crash debugging</a></li><li> <a href="https://dev-pro.xyz/blog/gestion-de-versions-des-bibliotheques-partagees/">Gestion de versions des bibliothÃ¨ques partagÃ©es</a></li><li> <a href="https://dev-pro.xyz/blog/flamegraph/">FlameGraph</a></li><li> <a href="https://dev-pro.xyz/blog/le-temps-reel-sous-linux/">Le Temps Reel sous Linux</a></li><li> <a href="https://dev-pro.xyz/blog/my-first-linux-kernel-built-with-clang-compiler/" aria-current="page">My first Linux kernel built with Clang compiler!</a></li></ul></aside><aside id="categories-3" class="widget widget_categories mb-5"><h3 class="widget-title mt-0">CatÃ©gories</h3><ul><li class="cat-item cat-item-137"><a href="https://dev-pro.xyz/blog/category/actu-linux/" title="Auto Added by WPeMatico">Actu Linux</a></li><li class="cat-item cat-item-145"><a href="https://dev-pro.xyz/blog/category/actualite-mobiles-et-tablettes/" title="Auto Added by WPeMatico">ActualitÃ© Mobiles et Tablettes</a></li><li class="cat-item cat-item-143"><a href="https://dev-pro.xyz/blog/category/actualite-windows-os-x-et-linux/" title="Auto Added by WPeMatico">ActualitÃ© Windows, OS X et Linux</a></li><li class="cat-item cat-item-151"><a href="https://dev-pro.xyz/blog/category/apple/" title="Auto Added by WPeMatico">Apple</a></li><li class="cat-item cat-item-161"><a href="https://dev-pro.xyz/blog/category/clang/" title="Auto Added by WPeMatico">clang</a></li><li class="cat-item cat-item-174"><a href="https://dev-pro.xyz/blog/category/crash/" title="Auto Added by WPeMatico">crash</a></li><li class="cat-item cat-item-175"><a href="https://dev-pro.xyz/blog/category/crashdump/" title="Auto Added by WPeMatico">crashdump</a></li><li class="cat-item cat-item-169"><a href="https://dev-pro.xyz/blog/category/debug/" title="Auto Added by WPeMatico">debug</a></li><li class="cat-item cat-item-138"><a href="https://dev-pro.xyz/blog/category/distribution-linux/" title="Auto Added by WPeMatico">Distribution Linux</a></li><li class="cat-item cat-item-152"><a href="https://dev-pro.xyz/blog/category/ecouteurs/" title="Auto Added by WPeMatico">Ecouteurs</a></li><li class="cat-item cat-item-158"><a href="https://dev-pro.xyz/blog/category/europe/" title="Auto Added by WPeMatico">Europe</a></li><li class="cat-item cat-item-146"><a href="https://dev-pro.xyz/blog/category/fcc/" title="Auto Added by WPeMatico">FCC</a></li><li class="cat-item cat-item-154"><a href="https://dev-pro.xyz/blog/category/film/" title="Auto Added by WPeMatico">Film</a></li><li class="cat-item cat-item-153"><a href="https://dev-pro.xyz/blog/category/geekeries-et-insolite/" title="Auto Added by WPeMatico">Geekeries et Insolite</a></li><li class="cat-item cat-item-157"><a href="https://dev-pro.xyz/blog/category/hors-sujet/" title="Auto Added by WPeMatico">Hors-Sujet</a></li><li class="cat-item cat-item-160"><a href="https://dev-pro.xyz/blog/category/howto/" title="Auto Added by WPeMatico">HowTo</a></li><li class="cat-item cat-item-147"><a href="https://dev-pro.xyz/blog/category/huawei/" title="Auto Added by WPeMatico">Huawei</a></li><li class="cat-item cat-item-139"><a href="https://dev-pro.xyz/blog/category/info-version/" title="Auto Added by WPeMatico">Info version</a></li><li class="cat-item cat-item-129"><a href="https://dev-pro.xyz/blog/category/installation-logiciel-linux/" title="Auto Added by WPeMatico">Installation Logiciel Linux</a></li><li class="cat-item cat-item-148"><a href="https://dev-pro.xyz/blog/category/justice/" title="Auto Added by WPeMatico">Justice</a></li><li class="cat-item cat-item-162"><a href="https://dev-pro.xyz/blog/category/kernel/" title="Auto Added by WPeMatico">kernel</a></li><li class="cat-item cat-item-176"><a href="https://dev-pro.xyz/blog/category/kexec/" title="Auto Added by WPeMatico">kexec</a></li><li class="cat-item cat-item-171"><a href="https://dev-pro.xyz/blog/category/libc/" title="Auto Added by WPeMatico">libc</a></li><li class="cat-item cat-item-172"><a href="https://dev-pro.xyz/blog/category/linker/" title="Auto Added by WPeMatico">linker</a></li><li class="cat-item cat-item-163"><a href="https://dev-pro.xyz/blog/category/linux/" title="Auto Added by WPeMatico">Linux</a></li><li class="cat-item cat-item-130"><a href="https://dev-pro.xyz/blog/category/linux-mint/" title="Auto Added by WPeMatico">Linux Mint</a></li><li class="cat-item cat-item-140"><a href="https://dev-pro.xyz/blog/category/linux-mint-19-3/" title="Auto Added by WPeMatico">Linux Mint 19.3</a></li><li class="cat-item cat-item-131"><a href="https://dev-pro.xyz/blog/category/machine-virtuelle/" title="Auto Added by WPeMatico">Machine virtuelle</a></li><li class="cat-item cat-item-150"><a href="https://dev-pro.xyz/blog/category/materiel-et-accessoires/" title="Auto Added by WPeMatico">MatÃ©riel et Accessoires</a></li><li class="cat-item cat-item-134"><a href="https://dev-pro.xyz/blog/category/messagerie-instantanee/" title="Auto Added by WPeMatico">Messagerie instantanÃ©e</a></li><li class="cat-item cat-item-63"><a href="https://dev-pro.xyz/blog/category/microsoft/" title="Auto Added by WPeMatico">Microsoft</a></li><li class="cat-item cat-item-141"><a href="https://dev-pro.xyz/blog/category/mise-a-niveau-linux/" title="Auto Added by WPeMatico">Mise Ã  niveau Linux</a></li><li class="cat-item cat-item-142"><a href="https://dev-pro.xyz/blog/category/mise-a-niveau-linux-mint/" title="Auto Added by WPeMatico">Mise Ã  niveau Linux Mint</a></li><li class="cat-item cat-item-170"><a href="https://dev-pro.xyz/blog/category/perf/" title="Auto Added by WPeMatico">perf</a></li><li class="cat-item cat-item-166"><a href="https://dev-pro.xyz/blog/category/preempt-rt/" title="Auto Added by WPeMatico">preempt-rt</a></li><li class="cat-item cat-item-76"><a href="https://dev-pro.xyz/blog/category/reseaux/" title="Auto Added by WPeMatico">RÃ©seaux</a></li><li class="cat-item cat-item-159"><a href="https://dev-pro.xyz/blog/category/samsung/" title="Auto Added by WPeMatico">Samsung</a></li><li class="cat-item cat-item-135"><a href="https://dev-pro.xyz/blog/category/skype/" title="Auto Added by WPeMatico">Skype</a></li><li class="cat-item cat-item-155"><a href="https://dev-pro.xyz/blog/category/sonic/" title="Auto Added by WPeMatico">Sonic</a></li><li class="cat-item cat-item-173"><a href="https://dev-pro.xyz/blog/category/symboles/" title="Auto Added by WPeMatico">symboles</a></li><li class="cat-item cat-item-164"><a href="https://dev-pro.xyz/blog/category/technologie/" title="Auto Added by WPeMatico">Technologie</a></li><li class="cat-item cat-item-167"><a href="https://dev-pro.xyz/blog/category/temps-reel/" title="Auto Added by WPeMatico">temps rÃ©el</a></li><li class="cat-item cat-item-156"><a href="https://dev-pro.xyz/blog/category/trailer/" title="Auto Added by WPeMatico">Trailer</a></li><li class="cat-item cat-item-127"><a href="https://dev-pro.xyz/blog/category/tuto-linux-mint/" title="Auto Added by WPeMatico">Tuto Linux Mint</a></li><li class="cat-item cat-item-128"><a href="https://dev-pro.xyz/blog/category/tuto-ubuntu/" title="Auto Added by WPeMatico">Tuto Ubuntu</a></li><li class="cat-item cat-item-136"><a href="https://dev-pro.xyz/blog/category/tuto-virtualbox/" title="Auto Added by WPeMatico">Tuto VirtualBox</a></li><li class="cat-item cat-item-132"><a href="https://dev-pro.xyz/blog/category/ubuntu/" title="Auto Added by WPeMatico">Ubuntu</a></li><li class="cat-item cat-item-1"><a href="https://dev-pro.xyz/blog/category/uncategorized/">Uncategorized</a></li><li class="cat-item cat-item-149"><a href="https://dev-pro.xyz/blog/category/usa/" title="Auto Added by WPeMatico">USA</a></li><li class="cat-item cat-item-133"><a href="https://dev-pro.xyz/blog/category/virtualbox/" title="Auto Added by WPeMatico">Virtualbox</a></li><li class="cat-item cat-item-177"><a href="https://dev-pro.xyz/blog/category/vmcore/" title="Auto Added by WPeMatico">vmcore</a></li><li class="cat-item cat-item-165"><a href="https://dev-pro.xyz/blog/category/whitepaper/" title="Auto Added by WPeMatico">WhitePaper</a></li><li class="cat-item cat-item-144"><a href="https://dev-pro.xyz/blog/category/windows-10/" title="Auto Added by WPeMatico">Windows 10</a></li><li class="cat-item cat-item-168"><a href="https://dev-pro.xyz/blog/category/xenomai/" title="Auto Added by WPeMatico">Xenomai</a></li></ul></aside></div></div></div></div><footer class="page-footer text-light"><div class="container"><div class="row"><div class="col-md-12"><div class="social-icons my-5 py-7 d-flex justify-content-center"></div></div></div></div><div class="footer-copyright text-center small bg-dimped__dark py-3"> <a class="text-light" href="">Â© 2019</a> <span class="sep text-light mx-2"> | </span> <a class="text-light" href="https://dev-pro.xyz/">Dev-Pro</a></div></footer></div> <noscript><style>.lazyload{display:none;}</style></noscript><script data-noptimize="1">window.lazySizesConfig=window.lazySizesConfig||{};window.lazySizesConfig.loadMode=1;</script><script async data-noptimize="1" src="https://dev-pro.xyz/blog/wp-content/plugins/autoptimize/classes/external/js/lazysizes.min.js"></script><script defer src="https://dev-pro.xyz/blog/wp-content/cache/autoptimize/js/autoptimize_430637a5ce5bae584155bf0968bdd4d3.js"></script></body></html>
