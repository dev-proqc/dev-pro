<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>HowTo &#8211; Dev-Pro Informatique</title>
	<atom:link href="http://localhost/wordpress/category/howto/feed/" rel="self" type="application/rss+xml" />
	<link>http://dev-pro.xyz/blog/</link>
	<description>Solution Technologique</description>
	<lastBuildDate>Fri, 27 Dec 2019 15:50:32 +0000</lastBuildDate>
	<language>fr-CA</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.3.2</generator>
	<item>
		<title>My first Linux kernel built with Clang compiler!</title>
		<link>https://dev-pro.xyz/blog/my-first-linux-kernel-built-with-clang-compiler/</link>
				<pubDate>Fri, 27 Dec 2019 15:50:32 +0000</pubDate>
		<dc:creator><![CDATA[siz]]></dc:creator>
				<category><![CDATA[clang]]></category>
		<category><![CDATA[HowTo]]></category>
		<category><![CDATA[kernel]]></category>
		<category><![CDATA[Linux]]></category>

		<guid isPermaLink="false">https://dev-pro.xyz/blog/my-first-linux-kernel-built-with-clang-compiler/</guid>
				<description><![CDATA[Following his internship at Smile in 2018 on LLVM/Clang integration into Buildroot [1], Valentin Korenblit still maintains these packages on his spare time (thanks to him!), up to the latest current version llvm/Clang 8.0.0. At the same time the Linux kernel continues evolving to support Clang compiler thanks to Google engineers. See Phoronix article [2] ... <a href="https://dev-pro.xyz/blog/my-first-linux-kernel-built-with-clang-compiler/" class="more-link text-uppercase small"><strong>Continue Reading</strong> <i class="fa fa-angle-double-right" aria-hidden="true"></i></a>]]></description>
								<content:encoded><![CDATA[<div>
<p>Following his internship at Smile in 2018 on LLVM/Clang integration into Buildroot [1], Valentin Korenblit still maintains these packages on his spare time (thanks to him!), up to the latest current version llvm/Clang 8.0.0.</p>
<p>At the same time the Linux kernel continues evolving to support Clang compiler thanks to Google engineers. See Phoronix article [2] and &laquo;&nbsp;Compiling the Linux kernel with LLVM tools&nbsp;&raquo; conference at FOSDEM 2019 [3].</p>
<p>Valentin stated in his internship report:</p>
<blockquote class="wp-block-quote">
<p>Clang was designed to offer GCC compatibility, so it accepts most of GCC&rsquo;s command line arguments to specify the compiler options. However, GCC offers a lot of extensions to the standard language while Clang&rsquo;s purpose is being standard-compliant. Because of this, Clang cannot be a replacement for GCC when compiling projects that depend on GCC extensions, as it happens with Linux kernel. In this case, Linux can&rsquo;t be built because Clang does not accept the following kinds of constructs:</p>
<p>&bull; Variable length arrays inside structures<br />&bull; Nested Functions<br />&bull; Explicit register variables</p>
<p>Furthermore, Linux kernel still depends on GNU assembler and linker.</p>
<p><cite>http://www.linuxembedded.fr/2018/07/llvmclang-integration-into-buildroot/</cite></p></blockquote>
<p>In order to check by ourselves if it is now possible to compile a kernel with Clang using buildroot, we will compile the aarch64 configuration for Qemu (qemu_aarch64_virt_defconfig).<br />First, we will try with the GCC toolchain in order to verify that everything works fine. Then we will recompile the kernel with Clang.</p>
<pre class="wp-block-preformatted">$ make qemu_aarch64_virt_defconfig</pre>
<p>In order to speedup the build, we use an prebuilt external toolchain (Arm AArch64 2019.03) instead of an internal toolchain. We could also use an aarch64 toolchain downloaded from toolchain-builder project (<a href="https://toolchains.bootlin.com/">https://toolchains.bootlin.com</a>) that provide several toolchains generated by Buildroot.</p>
<p>When the build is finished, we can test the system using Qemu as indicated in the file &laquo;&nbsp;board/qemu/aarch64-virt/readme.txt&nbsp;&raquo;</p>
<p>The system should boot correctly.<br />(If not, check your Qemu version and make sure it&rsquo;s at least at the same version as the one present in the readme.txt).</p>
<p>Now that we tested that the kernel build correctly with GCC, we are going to try again with Clang. To do that, we first clean the kernel&rsquo;s build directory</p>
<pre class="wp-block-preformatted">$ make linux-dirclean</pre>
<p>Note: We keep the user space content previously built by the GCC toolchain.<br />Building user space programs using Clang is not supported yet by buildroot.</p>
<p>We then need to build the Clang compiler itself. This is done by the host-clang package</p>
<p>We cannot select host-clang in buildroot&rsquo;s menuconfig, because host-clang can only be selected as a dependency of another package. We will simply trigger the host-clang build manually</p>
<pre class="wp-block-preformatted">$ make host-clang</pre>
<p>In order to cross-compile the kernel, we have to modify the Linux&rsquo;s package Makefile (linux/linux.mk) as suggested in the following patch.</p>
<div class="wp-block-file"><a href="http://www.linuxembedded.fr/wp-content/uploads/2019/08/0001-linux-compile-with-clang.patch_.zip">0001-linux-compile-with-clang.patch</a></div>
<p>Now it&rsquo;s time to rebuild the kernel using Clang <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="&#128578;" class="wp-smiley img-fluid" style="height: 1em; max-height: 1em;"><br />Note: By default the qemu_aarch64_virt_defconfig uses a kernel 4.19.x, it&rsquo;s recommended to use the latest kernel version (5.2.7).</p>
<pre class="wp-block-preformatted">$ make linux</pre>
<p>The kernel build takes some time to complete, you can check the list of processes running on you build machine thanks to the htop command. You should notice some activity with clang-8 process.</p>
<p>When the build is finished (and successful), restart Qemu using the same command line as before.</p>
<p>The system should boot successfully and you can check the dmesg output to know the compiler used to build the kernel.</p>
<figure class="wp-block-image"><img class="wp-image-6720 img-fluid" src="http://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50.png" alt="" srcset="https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50.png 970w, https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50-300x110.png 300w, https://www.linuxembedded.fr/wp-content/uploads/2019/08/Linux_kernel_built_with_clang_2019-08-06_22-02-50-768x283.png 768w" sizes="(max-width: 970px) 100vw, 970px"></figure>
<h2>Conclusion:</h2>
<p>This is our first test with a Linux kernel with Clang cross-compiler, for now it&rsquo;s just a hack in Buildroot&rsquo;s linux package.<br />Buildroot is not able to use Clang as a generic compiler for all user-space yet. Adding this feature requires discussion with the Buildroot community.</p>
<p>This support would also require to change some hard-coded references within the Buildroot&rsquo;s package infrastructure. CMake and meson cross-compilation support, in particular, would need some work.</p>
<p>Buildroot probably needs a new toolchain-wrapper for Clang compiler to provide &ndash;sysroot path and other compiler options like it does for the GCC cross-toolchain.<br />Since the Clang compiler take a lot of time to build, it would be interesting to be able to reuse a prebuilt Clang compiler and import it in the toolchain-external package infrastructure. This would require that LLVM/Clang binaries be relocatable.<br />For now, only aarch64 kernel has been tested since it probably the most tested one with Clang [5]. It would be interesting to do further tests with other architectures like arm, x86, x86_64, mips, mips64, ppc, ppc64&hellip;</p>
<p>References:</p>
<p>[1] <a href="http://www.linuxembedded.fr/2018/07/llvmclang-integration-into-buildroot">http://www.linuxembedded.fr/2018/07/llvmclang-integration-into-buildroot</a><br />[2] <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Google-2019-Clang-Kernel">https://www.phoronix.com/scan.php?page=news_item&amp;px=Google-2019-Clang-Kernel</a><br />[3] <a href="https://fosdem.org/2019/schedule/event/llvm_kernel/attachments/slides/3330/export/events/attachments/llvm_kernel/slides/3330/clang_linux_fosdem_19.pdf">https://fosdem.org/2019/schedule/event/llvm_kernel/attachments/slides/3330/export/events/attachments/llvm_kernel/slides/3330/clang_linux_fosdem_19.pdf</a><br />[4] <a href="https://www.elinux.org/Buildroot:DeveloperDaysFOSDEM2018#LLVM.2FClang">https://www.elinux.org/Buildroot:DeveloperDaysFOSDEM2018#LLVM.2FClang</a><br />[5] <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Clang-Kernel-2018">https://www.phoronix.com/scan.php?page=news_item&amp;px=Clang-Kernel-2018</a></p>
</div>
]]></content:encoded>
										</item>
	</channel>
</rss>
